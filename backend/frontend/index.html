<!DOCTYPE html>
<html>
<head>
    <title>Tariff Navigator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f0f0; }
        h1 { color: #667eea; text-align: center; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:hover { background: #5568d3; }
        .result { background: #e8f5e9; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #4caf50; cursor: pointer; }
        .result:hover { background: #c8e6c9; }
        .error { background: #ffebee; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #f44336; color: #c62828; }
        .best { background: #667eea; color: white; }
        .search-box { display: flex; gap: 10px; }
        .search-box input { flex: 1; }
        .search-box button { width: auto; }
        .tariff-code { background: #fff3e0; padding: 10px; margin: 5px 0; border-radius: 4px; cursor: pointer; border-left: 4px solid #ff9800; }
        .tariff-code:hover { background: #ffe0b2; }
        .tariff-code .code { font-weight: bold; color: #e65100; font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>🌐 Tariff Navigator</h1>
    
    <!-- HS Code Search Section -->
    <div class='section'>
        <h2>🔍 Search HS Codes</h2>
        <div class='search-box'>
            <input type='text' id='searchQuery' placeholder='Search product (e.g., car, phone, shirt)...'>
            <select id='searchCountry' style='width: 150px;'>
                <option value='US'>US</option>
                <option value='EU'>EU</option>
                <option value='CN'>China</option>
            </select>
            <button onclick='searchHS()' style='width: 100px;'>Search</button>
        </div>
        <div id='searchResults'></div>
    </div>
    
    <!-- Tariff Calculator Section -->
    <div class='section'>
        <h2>🧮 Calculate Import Duty</h2>
        <p>HS Code: <input type='text' id='hs' value='8703.23.00'></p>
        <p>Origin: 
            <select id='orig'>
                <option value='CN' selected>China (CN)</option>
                <option value='US'>United States (US)</option>
                <option value='EU'>European Union (EU)</option>
            </select>
        </p>
        <p>Destination:
            <select id='dest'>
                <option value='US' selected>United States (US)</option>
                <option value='EU'>European Union (EU)</option>
                <option value='CN'>China (CN)</option>
            </select>
        </p>
        <p>Value USD: <input type='number' id='val' value='30000'></p>
        <button onclick='calc()'>Calculate Duty</button>
    </div>
    
    <div id='out'></div>

    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        
        // Search HS Codes
        function searchHS() {
            var query = document.getElementById('searchQuery').value;
            var country = document.getElementById('searchCountry').value;
            var resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="error">Enter a search term</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div>Searching...</div>';
            
            fetch(API_URL + '/hs-codes/search?q=' + encodeURIComponent(query) + '&country=' + country + '&limit=50')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="error">No results found</div>';
                    return;
                }
                
                // Filter to show only tariff-level codes (full 10-digit codes)
                var tariffCodes = data.results.filter(function(item) {
                    return item.level === 'tariff' || item.code.includes('.');
                });
                
                // If no tariff codes, show all results
                var displayResults = tariffCodes.length > 0 ? tariffCodes : data.results;
                
                var html = '<h3>Click a code to select:</h3>';
                for (var i = 0; i < displayResults.length && i < 10; i++) {
                    var item = displayResults[i];
                    html += '<div class="tariff-code" onclick="selectHS(\'' + item.code + '\')">';
                    html += '<span class="code">' + item.code + '</span> - ' + item.description;
                    html += '</div>';
                }
                
                if (displayResults.length === 0) {
                    html += '<div class="error">No full tariff codes found. Try a more specific search.</div>';
                }
                
                resultsDiv.innerHTML = html;
            })
            .catch(function(e) {
                resultsDiv.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
            });
        }
        
        // Select HS Code from search
        function selectHS(code) {
            document.getElementById('hs').value = code;
            document.getElementById('searchResults').innerHTML = '<div class="result">✓ Selected: ' + code + '</div>';
        }
        
        // Calculate Tariff
        function calc() {
            var hs = document.getElementById('hs').value;
            var orig = document.getElementById('orig').value;
            var dest = document.getElementById('dest').value;
            var val = parseFloat(document.getElementById('val').value);
            var out = document.getElementById('out');
            
            if (!hs || !val) {
                out.innerHTML = '<div class="error">Please fill in all fields</div>';
                return;
            }
            
            out.innerHTML = '<div>Calculating...</div>';
            
            fetch(API_URL + '/tariffs/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    hs_code: hs,
                    origin: orig,
                    destination: dest,
                    value: val
                })
            })
            .then(function(r) { 
                if (!r.ok) {
                    return r.json().then(function(err) { throw new Error(err.detail || 'API Error'); });
                }
                return r.json(); 
            })
            .then(function(data) {
                var html = '<h2>Results:</h2>';
                
                if (!data.applicable_rates || data.applicable_rates.length === 0) {
                    out.innerHTML = '<div class="error">No tariff rates found for this HS code and trade lane. Try a different code or route.</div>';
                    return;
                }
                
                for(var i=0; i<data.applicable_rates.length; i++) {
                    var rate = data.applicable_rates[i];
                    var duty = (val * parseFloat(rate.duty_rate) / 100).toFixed(2);
                    var isBest = data.best_rate && rate.rate_type === data.best_rate.rate_type;
                    
                    html += '<div class="result ' + (isBest ? 'best' : '') + '">';
                    html += '<h3>' + rate.rate_type + (isBest ? ' ⭐ BEST' : '') + '</h3>';
                    html += '<p><strong>Rate:</strong> ' + rate.duty_rate + '%</p>';
                    html += '<p><strong>Duty:</strong> $' + duty + ' USD</p>';
                    if (rate.notes) html += '<p><small>' + rate.notes + '</small></p>';
                    html += '</div>';
                }
                
                var estimatedDuty = data.estimated_duty;
                if (estimatedDuty !== null && estimatedDuty !== undefined) {
                    var dutyNum = parseFloat(estimatedDuty);
                    if (!isNaN(dutyNum)) {
                        html += '<div style="background: #667eea; color: white; padding: 20px; border-radius: 4px; margin-top: 20px; text-align: center;">';
                        html += '<h2>Total Duty: $' + dutyNum.toFixed(2) + ' USD</h2>';
                        if (data.best_rate) {
                            html += '<p>Using ' + data.best_rate.rate_type + ' rate</p>';
                        }
                        html += '</div>';
                    }
                }
                
                out.innerHTML = html;
            })
            .catch(function(e) {
                out.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
            });
        }
        
        // Allow Enter key to search
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchHS();
        });
    </script>
</body>
</html>
